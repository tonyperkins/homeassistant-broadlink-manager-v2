# Media Player Platform Errors - FIXED

## Issue Summary

Users were experiencing these errors in Home Assistant:

### Error 1: Template Media Player Not Supported
```
ModuleNotFoundError: No module named 'homeassistant.components.template.media_player'
```

### Error 2: Multiple Platform Entries (if using older versions)
```
Platform error 'media_player' from integration 'template' - Platform template.media_player not found
```

These occurred when media_player entities were generated by Broadlink Manager.

## Root Cause

**Primary Issue:** Home Assistant does NOT support `template.media_player` platform. The template integration only supports:
- ✅ light, fan, switch, cover, sensor, binary_sensor
- ❌ media_player (NOT SUPPORTED)
- ❌ climate (removed in recent HA versions)

**Secondary Issue (older versions):** The entity generator was also creating separate platform entries for each entity instead of grouping them.

## Solution

Modified `app/entity_generator.py` to generate **universal media players** instead of template media players:

```yaml
# ✅ CORRECT (New behavior - Universal Platform)
media_player:
- platform: universal
  name: Living Room TV
  unique_id: living_room_tv
  children:
    - switch.living_room_tv_power
  commands:
    turn_on:
      service: switch.turn_on
      target:
        entity_id: switch.living_room_tv_power
    turn_off:
      service: switch.turn_off
      target:
        entity_id: switch.living_room_tv_power
    volume_up:
      service: remote.send_command
      target:
        entity_id: remote.broadcomir
      data:
        device: living_room_tv
        command: volume_up
  attributes:
    state: switch.living_room_tv_power

# Companion switch for power control
switch:
- platform: template
  switches:
    living_room_tv_power:
      friendly_name: Living Room TV Power
      value_template: "{{ is_state('input_boolean.living_room_tv_state', 'on') }}"
      turn_on:
        - service: remote.send_command
          target:
            entity_id: remote.broadcomir
          data:
            device: living_room_tv
            command: power_on
        - service: input_boolean.turn_on
          target:
            entity_id: input_boolean.living_room_tv_state
      turn_off:
        - service: remote.send_command
          target:
            entity_id: remote.broadcomir
          data:
            device: living_room_tv
            command: power_off
        - service: input_boolean.turn_off
          target:
            entity_id: input_boolean.living_room_tv_state
```

## What Changed

### Files Modified
- `app/entity_generator.py` - Methods:
  - `_generate_media_player()` - Now generates universal platform config
  - `_generate_media_player_switch()` - New method to create companion switches
  - `_build_entities_yaml()` - Updated to handle universal media players separately
  - `_build_helpers_yaml()` - Added source selection support for media players

### Key Changes
1. **Media players use universal platform** instead of template platform
2. **Companion switches auto-generated** for power control (e.g., `switch.living_room_tv_power`)
3. **Direct IR/RF commands** for media functions (volume, play/pause, etc.)
4. **Source selection support** via input_select helpers (if source commands exist)
5. **Template platform grouping** fixed for other entity types (light, fan, switch, etc.)

## Testing

Verified universal media player generation:
- ✅ Media players generate as `platform: universal`
- ✅ Companion switches auto-created for power control
- ✅ Volume, play/pause, and other media commands work correctly
- ✅ No template.media_player errors
- ✅ Template platform grouping works for other entity types

All tests pass successfully.

## User Action Required

Users experiencing this error should:

1. **Update the addon** to get this fix
2. **Regenerate entities** using the "Generate Entities" button in the UI
3. **Restart Home Assistant** to load the corrected configuration
4. **Verify** the errors are gone in Settings → System → Logs

## Expected Result

After the fix:
- ✅ No more "ModuleNotFoundError: No module named 'homeassistant.components.template.media_player'" errors
- ✅ Media players appear as universal platform entities
- ✅ Companion power switches created automatically
- ✅ Volume controls, play/pause, and other media functions work
- ✅ Configuration validation passes
- ✅ All entities appear in Home Assistant

## Technical Details

### Universal Media Player Platform
The fix uses Home Assistant's **universal media player** platform, which is designed for combining multiple entities and commands into a single media player interface. This is the correct approach for IR/RF controlled devices.

**Key features:**
- Uses a companion switch for power state tracking
- Direct IR/RF commands for media functions (volume, play/pause, etc.)
- Supports source selection via input_select helpers
- Fully compatible with Home Assistant media player cards

### Template Platform Grouping
For other entity types (light, fan, switch, etc.), the fix ensures:
- Each platform type has ONE `- platform: template` entry
- Multiple entities are grouped under the appropriate key (`lights:`, `fans:`, `switches:`, etc.)
- This matches the official Home Assistant documentation for template platforms

## Supported Media Player Commands

The universal media player supports these commands (if learned):
- **Power:** `power_on`, `power_off` (or `turn_on`, `turn_off`)
- **Volume:** `volume_up`, `volume_down`, `mute` (or `volume_mute`)
- **Playback:** `play`, `pause`, `play_pause`, `stop`
- **Navigation:** `next`, `previous` (or `next_track`, `previous_track`)
- **Source:** `source_hdmi1`, `source_hdmi2`, etc. (creates input_select for source switching)

## Related Issues

This fix also resolves template platform grouping for other entity types:
- ✅ Multiple lights now grouped under single template platform entry
- ✅ Multiple fans now grouped under single template platform entry
- ✅ Multiple switches now grouped under single template platform entry
